<!DOCTYPE html>
<html>
<head>
    <title>Multi-Contract Trading</title>
    <link href="//code.jquery.com/ui/1.10.3/themes/pepper-grinder/jquery-ui.min.css" rel="stylesheet" id="ui-theme">
    <link href="//dbnet-public.s3.amazonaws.com/css/jquery.ui.themeswitcher.css" rel="stylesheet">
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.4/jquery.mousewheel.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/globalize/0.1.1/globalize.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/globalize/0.1.1/cultures/globalize.culture.ja-JP.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/globalize/0.1.1/cultures/globalize.culture.en-AU.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/globalize/0.1.1/cultures/globalize.culture.en-GB.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/globalize/0.1.1/cultures/globalize.culture.en-US.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/globalize/0.1.1/cultures/globalize.culture.de-DE.js"></script>
    <script src="//code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
    <script src="//dbnet-public.s3.amazonaws.com/jquery.ui.themeswitcher.js"></script>

    <link href="css/wstrade.css" rel="stylesheet">
    <script src="/utility.js"></script>
</head>

<body>
    <div id="header" class="ui-widget ui-widget-header ui-helper-clearfix ui-corner-all local-content">

        <div id="themeswitcher"></div>

        <a href="https://www.binary.com">
            <img class="left ttip" title="Smart Prices.  Smart Trading" src="/img/binary-symbol-logo.svg"></img>
        </a>

        <div class="left" id="inhead">
            <h1>Multi-Contract Trading</h1>

            <form id="pricing_form">
                <div class="butonzone buttonset">
                    <button class="button online" icon="ui-icon-refresh" size="huge">Get Price</button>
                </div>
            </form>
            <form id="portfol_form">
                <div class="butonzone buttonset">
                    <button class="button online" icon="ui-icon-suitcase" size="huge">Portfolio</button>
                </div>
            </form>
            <form id="pauseit_form">
                <div class="butonzone buttonset">
                    <button class="button" icon="ui-icon-cancel" size="huge">Start</button>
                </div>
            </form>

        </div>

        <div id="tokenzone">
            <div>Binary.com API Token</div>
            <button class="button ttip" id="clear_token" icon="ui-icon-close" mute="1" title="Forget this Token"></button>
            <button class="button ttip" id="store_token" icon="ui-icon-check" mute="1" title="Save this Token"></button>
            <form id="mytoken_form">
                <input class="ui-corner-all ttip" type="password" placeholder="API Token Required" id="token" name="token"
    title="Supply a Binary.com API User Token (as found on the Settings page).  Stay logged in to Binary.com in another browser tab.  If valid, this token will be remembered for next Start."
                />
            </form>
            <div id="identity"></div>
        </div>

    </div>

    <div id="info-msg" class="ui-widget wstrade-notice ui-state-highlight ui-corner-all">
        <p><span class="left ui-icon ui-icon-info"></span><span class="notice"></span></p>
    </div>
    <div id="error-msg" class="ui-widget wstrade-notice ui-state-error ui-corner-all">
        <p><span class="left ui-icon ui-icon-alert"></span><span class="notice"></span></p>
    </div>

    <div class="ui-widget-content ui-corner-all ui-helper-clearfix">
        <div class="inputzone">
            <button id="select_symbol" type="button" class="button online" rcon="ui-icon-arrowthickstop-1-s">
            <span id="display_name">Trading</span>&hellip;</button>
            <div class="innerzone ui-state-highlight" id="symbolbuts" title="Choose Symbol">
                Retrieving tradeable symbols..
            </div>
        </div>
        <div class="inputzone">
            <div>
                <button id="select_contract" type="button" class="button online" rcon="ui-icon-arrowthickstop-1-s">
                <span id="contract_name">Contract Type</span>&hellip;
                </button>
            </div>
            <div class="innerzone ui-state-highlight" id="contractbuts" title="Contract Type">
                <div>
                    <div class="buttonset">
                        <input id="CALL-euro_atm" name="ct_bc" type="radio" value="CALL-euro_atm">
                        <label ct="CALL" for="CALL-euro_atm">Rises</label>
                        <input id="PUT-euro_atm" name="ct_bc" type="radio" value="PUT-euro_atm">
                        <label ct="PUT" for="PUT-euro_atm">Falls</label>
                    </div>
                    <div class="buttonset">
                        <input id="CALL-euro_non_atm" name="ct_bc" type="radio" value="CALL-euro_non_atm">
                        <label ct="CALL" for="CALL-euro_non_atm">Higher</label>
                        <input id="PUT-euro_non_atm" name="ct_bc" type="radio" value="PUT-euro_non_atm">
                        <label ct="PUT" for="PUT-euro_non_atm">Lower</label>
                    </div>
                    <br/>
                    <div class="buttonset">
                        <input id="EXPIRYRANGE-euro_atm" name="ct_bc" type="radio" value="EXPIRYRANGE-euro_atm">
                        <label ct="EXPIRYRANGE" for="EXPIRYRANGE-euro_atm">Ends Outside</label>
                        <input id="EXPIRYMISS-euro_atm" name="ct_bc" type="radio" value="EXPIRYMISS-euro_atm">
                        <label ct="EXPIRYMISS" for="EXPIRYMISS-euro_atm">Ends Between</label>
                    </div>
                    <br/>
                    <div class="buttonset">
                        <input id="RANGE-american" name="ct_bc" type="radio" value="RANGE-american">
                        <label ct="RANGE" for="RANGE-american">Stays Between</label>
                        <input id="UPORDOWN-american" name="ct_bc" type="radio" value="UPORDOWN-american">
                        <label ct="UPORDOWN" for="UPORDOWN-american">Goes Outside</label>
                    </div>
                    <br/>
                    <div class="buttonset">
                        <input id="ONETOUCH-american" name="ct_bc" type="radio" value="ONETOUCH-american">
                        <label ct="ONETOUCH" for="ONETOUCH-american">Touches</label>
                        <input id="NOTOUCH-american" name="ct_bc" type="radio" value="NOTOUCH-american">
                        <label ct="NOTOUCH" for="NOTOUCH-american">Does Not Touch</label>
                    </div>
                    <br/>
                    <div class="buttonset">
                        <input id="ASIANU-asian" name="ct_bc" type="radio" value="ASIANU-asian">
                        <label ct="ASIANU" for="ASIANU-asian">Asian Up</label>
                        <input id="ASIAND-asian" name="ct_bc" type="radio" value="ASIAND-asian">
                        <label ct="ASIAND" for="ASIAND-asian">Asian Down</label>
                    </div>
                    <br/>
                    <div class="buttonset">
                        <input id="DIGITMATCH-non_financial" name="ct_bc" type="radio" value="DIGITMATCH-non_financial">
                        <label ct="DIGITMATCH" for="DIGITMATCH-non_financial">Digit Matches</label>
                        <input id="DIGITDIFF-non_financial" name="ct_bc" type="radio" value="DIGITDIFF-non_financial">
                        <label ct="DIGITDIFF" for="DIGITDIFF-non_financial">Digit Differs</label>
                    </div>
                </div>
                <div id="barriers">
                    <div class="cts CALL PUT ONETOUCH NOTOUCH euro_non_atm american">
                        <label for="barrier">Target Value</label>
                        <input class="thininput" id="barrier" name="barrier" value="0">
                        <div id="slider1"></div>
                    </div>
                    <div class="cts EXPIRYRANGE EXPIRYMISS RANGE UPORDOWN euro_non_atm american">
                        <label for="barrier2">Low Barrier </label>
                        <input class="thininput" id="barrier2" name="barrier2" value="-5">
                        &mdash;
                        <input class="thininput" id="barrier" name="barrier" value="5">
                        <label for="barrier"> High Barrier</label>
                        <div id="slider2"></div>
                    </div>
                    <div class="cts DIGITMATCH DIGITDIFF non_financial">
                        Last Digit<br/><br/>
                        <div class="buttonset">
                            <input id="digit0" name="barrier" type="radio" value="0">
                            <label for="digit0">0</label>
                            <input id="digit1" name="barrier" type="radio" value="1">
                            <label for="digit1">1</label>
                            <input id="digit2" name="barrier" type="radio" value="2">
                            <label for="digit2">2</label>
                            <input id="digit3" name="barrier" type="radio" value="3">
                            <label for="digit3">3</label>
                            <input id="digit4" name="barrier" type="radio" value="4">
                            <label for="digit4">4</label>
                            <input id="digit5" name="barrier" type="radio" value="5">
                            <label for="digit5">5</label>
                            <input id="digit6" name="barrier" type="radio" value="6">
                            <label for="digit6">6</label>
                            <input id="digit7" name="barrier" type="radio" value="7">
                            <label for="digit7">7</label>
                            <input id="digit8" name="barrier" type="radio" value="8">
                            <label for="digit8">8</label>
                            <input id="digit9" name="barrier" type="radio" value="9">
                            <label for="digit9">9</label>
                        </div>
                    </div>
                </div>
                <div class="memo"></div>
                <input id="contract_type" name="contract_type" type="hidden" value="">
                <input id="barrier_category" name="barrier_category" type="hidden" value="">
            </div>
        </div>
        <div class="inputzone">
            <div>
                <button id="select_payout" type="button" class="button online" rcon="ui-icon-arrowthickstop-1-s">
                <span id="payout_name">Contract Value</span>&hellip;
                </button>
            </div>
            <div class="innerzone ui-state-highlight buttonset" id="payoutflds" title="Contract Value">
                <div class="buttonset">
                    <input id="Payout" name="basis" type="radio" value="payout">
                    <label for="Payout">Payout</label>
                    <input id="Stake" name="basis" type="radio" value="stake">
                    <label for="Stake">Stake</label>
                </div>
                <br/>
                <div class="buttonset" id="currencies">
                    <input id="USD" name="currency" type="radio" value="USD">
                    <label for="USD">USD</label>
                    <input id="EUR" name="currency" type="radio" value="EUR">
                    <label for="EUR">EUR</label>
                    <input id="AUD" name="currency" type="radio" value="AUD">
                    <label for="AUD">AUD</label>
                    <input id="GBP" name="currency" type="radio" value="GBP">
                    <label for="GBP">GBP</label>
                    <input id="YEN" name="currency" type="radio" value="YEN">
                    <label for="YEN">YEN</label>
                </div>
                <br/>
                <div>
                    <input id="amount_str" name="amount_str" value="10">
                    <label for="amount_str">Value</label>
                    <input id="amount_val" name="amount_val" type="hidden" value="10">
                </div>
            </div>
        </div>
        <div class="inputzone">
            <div>
                <button id="select_start" type="button" class="button online" rcon="ui-icon-arrowthickstop-1-s">
                <span id="start_str">Starting..</span>&hellip;
                </button>
            </div>
            <div class="innerzone ui-state-highlight" id="startflds" title="Contract Starts">
                <div class="ui-helper-clearfix">
                    <div class="left buttonset">
                        <input id="start_immed" name="start_when" type="radio" value="start_immed">
                        <label for="start_immed">Start Immediately</label>
                        <input id="start_in" name="start_when" type="radio" value="start_in">
                        <label for="start_in">Start In..</label>
                        <input id="start_at" name="start_when" type="radio" value="start_at">
                        <label for="start_at">Start At..</label>
                    </div>
                    <div class="left date_start_in_ctr" style="margin-top:15px; clear:left">
                        <input class="thininput" id="date_start_in" name="date_start_in" value="0">
                    </div>
                    <div class="buttonset left date_start_in_ctr" style="margin-top:12px">
                        <input id="date_start_unit_Days" name="date_start_unit" type="radio" value="d">
                        <label for="date_start_unit_Days">Days</label>
                        <input id="date_start_unit_Hours" name="date_start_unit" type="radio" value="h">
                        <label for="date_start_unit_Hours">Hours</label>
                        <input id="date_start_unit_Minutes" name="date_start_unit" type="radio" value="m">
                        <label for="date_start_unit_Minutes">Minutes</label>
                        <input id="date_start_unit_Seconds" name="date_start_unit" type="radio" value="s">
                        <label for="date_start_unit_Seconds">Seconds</label>
                    </div>
                    <div class="left date_start_at_ctr" style="margin-top:12px; clear:left">
                        <input class="thininput" id="date_start_at" name="date_start_at" value="">
                    </div>
                </div>
                <div class="memo"></div>
                <input id="date_start" name="date_start" type="hidden" value="0">
            </div>
        </div>
        <div class="inputzone">
            <div>
                <button id="select_duration" type="button" class="button online" rcon="ui-icon-arrowthickstop-1-s">
                <span id="duration_str">Contract Duration</span>&hellip;
                </button>
            </div>
            <div class="innerzone ui-state-highlight" id="durationflds" title="Contract Duration">
                <div class="ui-helper-clearfix">
                    <div class="left" style="margin-top:3px">
                        <label for="duration">Expires in </label>
                        <input class="thininput" id="duration" name="duration" value="900">
                    </div>
                    <div class="buttonset left">
                        <input id="Days" name="duration_unit" type="radio" value="d">
                        <label for="Days">Days</label>
                        <input id="Hours" name="duration_unit" type="radio" value="h">
                        <label for="Hours">Hours</label>
                        <input id="Minutes" name="duration_unit" type="radio" value="m">
                        <label for="Minutes">Minutes</label>
                        <input id="Seconds" name="duration_unit" type="radio" value="s">
                        <label for="Seconds">Seconds</label>
                        <input id="Ticks" name="duration_unit" type="radio" value="t">
                        <label for="Ticks">Ticks</label>
                    </div>
                    <div class="left" style="margin-top:12px; clear:left">
                        OR Expires at end of
                    </div>
                    <div class="left" style="clear:left">
                        <input type="text" id="duration_date"></input>
                    </div>
                </div>
                <div class="memo"></div>
            </div>
        </div>
    </div>

    <div class="ui-widget ui-widget-content ui-corner-all" id="outhalf">
        <div class="ui-helper-clearfix" id="contracts">
        </div>
    </div>

    <script>
        var g = new Object;
        g.currency_cultures = {USD:'en-US',GBP:'en-GB',AUD:'en-AU', EUR:'de-DE',YEN:'ja-JP'};
        g.nicetypes = {};
        g.live_contracts = {};
        g.limits_for = {};
        g.fmb_ids = {};
        g.$live_symbols = {};
        g.$contracts = $('#contracts');
        g.init_trade = {symbol:'R_100',ct_bc:'CALL-euro_atm',duration:900,duration_unit:'Seconds',basis:'Payout',currency:'USD',amount_val:10,date_start:0};
        g.contracts_built = 0;
        g.timezone_offset = (new Date()).getTimezoneOffset()*60;
        g.Contract = function(data) {
            console.log("new contract data %o", data);
            var symobj = g.all_symbols[data.symbol];
            if (!symobj) {
                console.log("will not build, no symbol " + data.symbol);
                return
            }
            var ct_bc = data.contract_type;
            if (data.barrier_category) ct_bc += '-' + data.barrier_category;
            var brief = symobj.display_name + '<br/>' + (g.nicetypes[ct_bc]||data.contract_type);
            this.bSell = !!data.fmb_id;
            var buysell = this.bSell? 'SELL': 'BUY';
            var div = '<div id="' + data.id + '" class="contract ui-state-default">'
                         + '<div class="contract_header ui-helper-clearfix">'
                             + '<button class="forget right" size="baby" mute="1" icon="ui-icon-circle-close">Close</button>'
                             + '<button class="dtldlg right" size="baby" mute="1" icon="ui-icon-help">Details</button>'
                             + '<div class="proposal">Offer</div>'
                             + '<span class="error"></span>'
                             + '<button class="purchase" size="huge" icon="ui-icon-cart">' + buysell + '</button>'
                         + '</div>'
                         + '<div><span class="bigtext">' + brief + '</span></div>'
                         + '<div><div class="ttype elbow">Not Offered</div><span class="price bigtext"></span></div>'
                         + '<div><div class="basis elbow">Payout</div><span class="payout bigtext"></span></div>'
                         + '<div><div class="symbol elbow"></div><span class="spot bigtext"></span></div>'
                         + '<div class="longcode"></div>'
                         + '<div class="contract_dlg" title="Contract Details"></div>'
                      + '</div>'
            $('#contracts').append(div);
            this.d0 = data;
            this.$div = $('#'+data.id, g.$contracts);
            this.$dlg = $('div.contract_dlg', this.$div).dialog({autoOpen:false});
            $('button', this.$div).each(buttonmaker);
            $('button.forget', this.$div).click(forget);
            $('button.dtldlg', this.$div).click(dtldlg);
            $('button.purchase', this.$div).click(purchase);
            if (this.bSell) {
                this.$div.removeClass('ui-state-active').addClass('ui-state-highlight');
                $('.proposal', this.$div).html('Contract ' + data.fmb_id);
            }
        };
        g.Contract.prototype.update = function(data) {
            //console.log("update with %o", data);
            for (fld in data) {
                var $div = $('.'+fld, this.$div);
                var val = fld == 'basis'? data[fld].initCap(): data[fld];
                $div.html(val);
                this.d0[fld] = val;
            }
            if (data.payout) {
                var cul = g.currency_cultures[this.d0.currency];
                var pay = Globalize.format(parseFloat(data.payout   ), 'C', cul);
                $('.payout', this.$div).html(pay);
            }
            var ttype, price;
            if (data.sell) {
                ttype = 'Sold for';
                price = data.sold_for;
            } else if (this.bSell) {
                ttype = 'Sell for';
                price = data.bid_price;
            } else {
                ttype = 'Buy for';
                price = data.ask_price;
            }
            if (!price && data.buy_price) {
                ttype = 'Bought for';
                price = data.buy_price;
            }
            if (price) {
                var cul = g.currency_cultures[this.d0.currency];
                var val = Globalize.format(parseFloat(price), 'C', cul);
                $('.price', this.$div).html(val);
                $('.ttype', this.$div).html(ttype);
            }
            if (data.fmb_id && data.trx_id) {
                this.bSell = true;
                $('button.purchase', this.$div).button('option', 'label', data.fmb_id);
                this.$div.removeClass('ui-state-active').addClass('ui-state-highlight');
                $('.proposal', this.$div).html('Contract ' + data.fmb_id);
            }
            var details = '';
            if (this.bSell) {
                if (data.fmb_id) {
                    details += 'Contract Number '+ data.fmb_id + '<br/>';
                    if (data.trx_id)        details += 'Transaction Number '+ data.trx_id + '<br/>';
                    if (data.buy_price)     details += 'Bought for '+ data.buy_price + '<br/>';
                    if (data.expiry_time)   details += 'Expires '   + niceDate(data.expiry_time) + '<br/>';
                    if (data.purchase_time) details += 'Purchased ' + niceDate(data.purchase_time) + '<br/>';
                    if (data.start_time)    details += 'Contract Starts ' + niceDate(data.start_time) + '<br/>';
                    if (data.balance_after) details += 'Balance After ' + data.balance_after + '<br/>';
                }
            } else {
                details += 'Not yet purchased<br/>';
                if (data.date_start)    details += 'Proposed Start Time '+ niceDate(data.date_start) + '<br/>';
            }

                if (details) this.$dlg.html(details);
                if (data.error) {
                    this.$div.removeClass('ui-state-active').addClass('ui-state-error');
                    $('button.purchase', this.$div).hide();
                    $('span.error', this.$div).show();
                    var detail = data.detail || 
                                ( (data.basis||' ')
                                + (data.amount_str? (data.amount_str + ' '): ''               )
                                + (data.duration && data.duration_unit? ('over '+data.duration+data.duration_unit+' '): '')
                                + (data.data_start? ('starting '+niceDate(data.date_start)+' '): '' ) );
                    $('.longcode', this.$div).html(detail);
                }
            };
            g.Contract.prototype.destroy = function() {
                this.$div && this.$div.remove();
            };

            function build_symbols(offerings) {
                var buttonsets = '';
                $.each(offerings.offerings, function(i, mkt) {
                    $.each(mkt.available, function(i, sbm) {
                        var emptyset = true;
                        $.each(sbm.available, function(i, sym) {
                            var symbol = sym.symbol_display;
                            var symobj = g.all_symbols[symbol];
                            if (!symobj) return;
                            if (emptyset) buttonsets += '<h3>' + mkt.market + ' &mdash; ' + sbm.submarket + '</h3>' + '<div class="buttonset">';
                            emptyset = false;
                            var s = symobj.symbol;
                            g.all_symbols[s] = symobj; // this map is now keyed by both short- and display-name
                            buttonsets += '<input type="radio" name="symbol" value="' + s + '" id="' + s + '"/>'
                                       + '<label for="' + s + '">' + symbol + '</label>';
                        })
                        if (!emptyset) buttonsets += '</div>';
                    })
                });
                //console.log("buttonset now %o", buttonset);
                $('#symbolbuts').html(buttonsets).accordion({collapsible:true, heightStyle:'content'});
                $('#symbolbuts .buttonset').buttonset();
                $('#symbolbuts label').tooltip({items:"label", open: opensym, close: closesym, content: showsym});
                $('#symbolbuts input[name=symbol]').change(change_symbol);
                // initial trading values..
                $('#symbolbuts input#' + g.init_trade.symbol).prop('checked',true).button('refresh').change();
                $('#contractbuts input#' + g.init_trade.ct_bc).prop('checked',true).button('refresh').change();
                $('#durationflds input#duration').val(g.init_trade.duration);
                $('#durationflds input#' + g.init_trade.duration_unit).prop('checked',true).button('refresh').change();
                $('#payoutflds input#' + g.init_trade.basis).prop('checked',true).button('refresh');
                $('#payoutflds input#' + g.init_trade.currency).prop('checked',true).button('refresh');
                $('#payoutflds #amount_str').spinner('value', g.init_trade.amount_val); change_payout(0);
                // first proposal..
                $('#pricing_form').trigger("submit");
            }
            function closesym(ev, ui) {
                var symbol = ui.tooltip.data('symbol');
                delete g.$live_symbols[symbol];
                var symbol_id = ui.tooltip.data('symbol_id');
                if (symbol_id) {
                    delete g.$live_symbols[symbol_id];
                    g.ws.send(JSON.stringify({forget:symbol_id}));
                }
            }
            function opensym(ev, ui) {
                var symbol = $('h2.livesym', ui.tooltip).attr('symbol');
                ui.tooltip.data('symbol', symbol);
                g.$live_symbols[symbol] = ui.tooltip;
                g.ws.send(JSON.stringify({ticks:symbol}));
            }
            function spot_report(s) {
                var d = new Date(s.spot_time*1000);
                var str = '<h2 class="livesym" symbol="' + s.symbol + '">'
                        + s.display_name + ": " + s.quoted_currency_symbol + " " + s.spot + "</h2>"
                        + "<div>" + s.exchange_name + " &mdash; " + s.symbol + "</div>"
                        + "<div> as at " + d.toUTCString() + "</div>";
                if (s.error) str += '<div class="ui-state-error">' + s.error + '</div>';
                return str
            }
            function showsym() {
                var $this = $(this);
                var symbol = $this.text();
                return spot_report(g.all_symbols[symbol]);
            }
            function onmessage(m) {
                var data = JSON.parse(m.data);
                //console.log('incoming message %o', data);
                if (data.authorize) {
                    if (data.error) {
                        notice(data.error,'error');
                        return;
                    }
                    onauthorized(data);
                    return;
                }
                if (data.ticks) {
                    var symbol = data.ticks;
                    var $live_symbol = g.$live_symbols[symbol];
                    if (!$live_symbol) {
                        if (data.id) g.ws.send(JSON.stringify({forget:data.id}));
                        return;
                    }
                    if (data.id && !g.$live_symbols[data.id]) g.$live_symbols[data.id] = $live_symbol; 
                    var s = g.all_symbols[symbol];
                    if (data.error) {
                        s.error = data.error
                    } else {
                        delete s.error;
                        s.spot = data.quote;
                        s.spot_time = data.epoch;
                    }
                    $live_symbol.html(spot_report(s));
                    return;
                }
                if (data.active_symbols) {
                    g.all_symbols = data.active_symbols;
                    g.ws.send(JSON.stringify({offerings:{}}));
                    return;
                }
                if (data.offerings) {
                    console.log("offerings data is %o", data);
                    build_symbols(data.offerings);
                    return;
                }
                if (data.buy) {
                    console.log("buy result data is %o", data);
                    var contract = g.live_contracts[data.buy];
                    if (!contract) {
                        console.log("dropping buy result for " + data.buy);
                        g.ws.send(JSON.stringify({forget:data.buy}));
                        return;
                    }
                    g.fmb_ids[data.fmb_id] = contract;
                    contract.update(data);
                    return
                }
                if (data.sell) {
                    console.log("sell result data is %o", data);
                    var contract = g.live_contracts[data.sell];
                    if (!contract) {
                        console.log("dropping sell result for " + data.sell);
                        g.ws.send(JSON.stringify({forget:data.sell}));
                        return;
                    }
                    contract.update(data);
                    return
                }
                if (data.portfolio_stats) {
                    g.portfolio_stats = data.portfolio_stats;
                    console.log("portfolio stats: %o", g.portfolio_stats);
                    if (g.portfolio_stats.batch_count==0) $('#portfol_form button').button('enable');
                    return;
                }
                if (data.contracts_for) {
                    var symbol = data.contracts_for.symbol;
                    delete data.contracts_for.symbol;
                    console.log("limits_for " + symbol + ": %o", data.contracts_for);
                    g.limits_for[symbol] = data.contracts_for;
                    apply_limits();
                    return;
                }
                // any other input message should be about a contract.
                var contract_id = data.id;
                var contract = g.live_contracts[contract_id];
                if (!contract) {
                    if (data.fmb_id) {
                        if (data.batch_index == data.batch_count) {
                            $('#portfol_form button').button('enable');
                        }
                        if (g.fmb_ids[data.fmb_id]) {
                            console.log("already showing fmb_id " + data.fmb_id +"; forget " + data.id);
                            g.ws.send(JSON.stringify({forget:data.id}));
                            return
                        }
                    }
                    contract = new g.Contract(data);
                    if (!contract.d0) { // means not built successfully
                        console.log("did not build; forget " + contract_id);
                        g.ws.send(JSON.stringify({forget:contract_id}));
                        contract.destroy();
                        return
                    }
                    g.live_contracts[contract_id] = contract;
                    g.contracts_built++;
                    if (data.fmb_id) g.fmb_ids[data.fmb_id] = contract;
                    clear_notice('info');
                }
                contract.update(data);
            }
            function apply_limits() {
                var sym = $('#symbolbuts input[name=symbol]:checked').attr('id');
                if (!sym) return;
                var limits = g.limits_for[sym];
                if (!limits) return;
                console.log("apply limits for " + sym + " using %o", limits);
                $('#contractbuts input[name=ct_bc]').button('disable').removeData('limits');
                $.each(limits.available, function(i,limit){
                    var ct_bc = limit.contract_type + '-' + limit.barrier_category;
                    var $but = $('#contractbuts input#'+ct_bc);
                    $but.button('enable');
                    var limits = $but.data('limits') || [];
                    limits.push(limit);
                    $but.data('limits',limits);
                });
                if ($('#contractbuts input[name=ct_bc]:checked:disabled').length) {
                    $('#contractbuts input[name=ct_bc]:enabled').first().prop('checked',true).button('refresh');
                }
                var $but = $('#contractbuts input[name=ct_bc]:checked');
                console.log("with data %o", $but.data('limits'));
                $but.change();
            }
            function forget() {
                var contract_id = $(this).parents('.contract').attr('id');
                //console.log("I want to forget " + contract_id);
                g.ws.send(JSON.stringify({forget:contract_id}));
                var contract = g.live_contracts[contract_id];
                if (contract.d0.fmb_id) delete g.fmb_ids[contract.d0.fmb_id];
                delete g.live_contracts[contract_id];
                contract.destroy();
            }
            function dtldlg() {
                var contract_id = $(this).parents('.contract').attr('id');
                var contract = g.live_contracts[contract_id];
                console.log("detail for %o!", contract);
                contract.$dlg.dialog('open');
            }
            function purchase() {
                var contract_id = $(this).parents('.contract').attr('id');
                var contract = g.live_contracts[contract_id];
                $(this).button('disable').button('option', 'label', 'Wait..');
                if (contract.bSell) {
                    var price = contract.d0.bid_price;
                    console.log("selling " + contract_id + " from %o " + " for " + price, contract);
                    g.ws.send(JSON.stringify({sell:contract_id, price:price}));
                    return;
                }
                var price = contract.d0.ask_price;
                console.log("buying " + contract_id + " from %o " + " for " + price, contract);
                g.ws.send(JSON.stringify({buy:contract_id, price:price}));
            }
            function pricing_submit(e) {
                var data = {};
                var arr = $('input, select', $('.innerzone')).serializeArray();
                $.each(arr,function(idx,val){data[val.name]=val.value});
                console.log("submitting data %o", data);
                g.ws.send(JSON.stringify(data));
                if (e) e.preventDefault();
            }
            function portfol_submit(e) {
                $('#portfol_form button').button('disable');
                g.ws.send(JSON.stringify({portfolio:1}));
                $('.innerzone.ui-dialog-content').dialog('close');
                if (e) e.preventDefault();
            }
            function pauseit_submit(e) {
                var $but = $('#pauseit_form button');
                var newText;
                if (!$but.prop('started')) {
                    g.token = $('#token').val();
                    if (g.token) {
                        notice('Opening connection to Binary.com');
                        opensocket();
                    } else {
                        notice('API Token Required','error');
                    }
                } else if ($but.prop('paused')) {
                    $but.prop('paused', false);
                    newText = 'Pause';
                    notice('Resuming connection to Binary.com');
                    opensocket();
                } else {
                    $('.ui-button.online').button('disable');
                    $but.prop('paused', true);
                    newText = 'Resume';
                    g.ws.onclose = function(){};
                    notice('Closing connection to Binary.com');
                    g.ws.close();
                }
                if (newText) $('span.ui-button-text', $but).text(newText);
                if (e) e.preventDefault();
            }
            function mytoken_submit(e) {
                if (e) e.preventDefault();
                if (!$('#token').val()) return;
                $('button#clear_token').show();
                pauseit_submit();
            }
            function change_payout(e) {
                var cur = $('input[name=currency]:checked').val();
                var cul = g.currency_cultures[cur];
                Globalize.culture(cul); // this is to also set the start_at timespinner format
                $('#amount_str').spinner('option', 'culture', cul);
                var val = $('#amount_str').spinner('value');
                $('#amount_val').val(val);
                var basis = $('input[name=basis]:checked').val();
                if (basis) $('#payout_name').html("For a " + basis + " of " + $('#amount_str').val());
            }
            function change_symbol(e) {
                var symbol = this.id;
                var symobj = g.all_symbols[symbol];
                $('#display_name').html("Trading " + symobj.display_name);
                if (g.limits_for[symbol]) {
                    apply_limits();
                    return
                }
                g.ws.send(JSON.stringify({contracts_for:symbol}));
            }
            function change_contract(e) {
                var $ct_bc = $('input[name=ct_bc]:checked');
                var ct_bc = $ct_bc.val();
                $('#contract_name').html(g.nicetypes[ct_bc] || ct_bc);
                var match = /(.*)-(.*)/.exec(ct_bc);
                var ct = match[1];
                var bc = match[2];
                $('#contract_type').val(ct);
                $('#barrier_category').val(bc);
                $('#barriers .cts'           ).hide().find('input').prop('disabled', true);
                $('#barriers .cts.'+ct+'.'+bc).show().find('input').prop('disabled', false);
                var limits = $ct_bc.data('limits');
                if (!limits) return;
                console.log("chosen ct " + ct + " bc " + bc + ' with limits %o', limits);
                // disable all start options and enable relevant ones..
                $('#startflds input[name=start_when]').button('disable');
                var fs_memo = '';
                var du_memo = '';
                var cb_memo = '';
                $.each(limits, function(i, lim) {
                    //console.log("report limit " + i + " %o", lim);
                    if (lim.start_type == 'spot')    $('#startflds input#start_immed').button('enable');
                    if (lim.start_type == 'forward') {
                        $('#startflds input#start_in').button('enable');
                        $('#startflds input#start_at').button('enable');
                        if (lim.forward_starting_options) {
                            $.each(lim.forward_starting_options, function(i, fso) {
                                fs_memo += '<div>on ' + niceDayUTC(fso.date)
                                        + ' between ' + niceTimeUTC(fso.open)
                                        + ' and ' + niceTimeUTC(fso.close) + '</div>';
                            });
                        }
                    }
                    $('#startflds input[name=start_when]:enabled').first().prop('checked',true).button('refresh');
                    change_startwhen();
                    var du_label = '';
                    if (lim.expiry_type == 'intraday') du_label = 'Today';
                    if (lim.expiry_type == 'daily'   ) du_label = 'Whole days';
                    if (lim.expiry_type == 'tick'    ) du_label = 'Ticks';
                    if (lim.start_type == 'forward'  ) du_label += '(delayed start)';
                    du_memo += '<div>' + du_label + ' between ' + lim.min_contract_duration + ' and ' + lim.max_contract_duration + '</div>';
                    if (lim.barriers == 1 && lim.barrier_category != 'non_financial')
                        cb_memo += '<div>' + lim.expiry_type + ' durations: ' + lim.barrier + '</div>';
                    if (lim.barriers == 2 && lim.barrier_category != 'non_financial')
                        cb_memo += '<div>' + lim.expiry_type + ' durations: Between ' + lim.low_barrier + ' and ' + lim.high_barrier + '</div>';
                });
                if (fs_memo) fs_memo = '<p>Start times available (UTC) for this contract..' + fs_memo + '</p>';
                if (du_memo) du_memo = '<p>Durations available for this contract..'         + du_memo + '</p>';
                if (cb_memo) cb_memo = '<p>Valid targets for this contract..'               + cb_memo + '</p>';
                $('#startflds    div.memo').html(fs_memo);
                $('#durationflds div.memo').html(du_memo);
                $('#contractbuts div.memo').html(cb_memo);

            }
            function change_duration_date(datestr,dp) {
                var today = new Date();
                var thatDate = $(this).datepicker('getDate');
                var days = Math.round((thatDate - today)/(1000*60*60*24));
                $("input#Days").prop("checked",true).button('refresh');
                $('#duration').spinner("value", days+1);
                change_duration(0);
            }
            function change_duration(e) {
                var duration_str = $('input[name=duration]').val() + ' ' + $('input[name=duration_unit]:checked').attr('id');
                $('#duration_str').html("Expiry in " + duration_str);
            }
            function load_nicetypes(i,v) {
                var ct_bc = $(v).attr('for');
                var ct    = $(v).attr('ct');
                // map both ct on its own and the ct_bc pair; this allows lookup when we only have ct available.
                g.nicetypes[ct] = $(v).text();
                g.nicetypes[ct_bc] = $(v).text();
            }
            function change_slider1(e,rs) {
                $('#barrier').val(rs.value);
            }
            function change_slider2(e,rs) {
                $('#barrier').val(rs.values[0]);
                $('#barrier2').val(rs.values[1]);
            }
            function change_startwhen(e) {
                var start_when = $('input[name=start_when]:checked').val();
                $('#date_start_in').prop('disabled',true);
                $('input[name=date_start_unit]').button('disable');
                $('#date_start_at').timespinner('disable');
                $('.date_start_in_ctr, .date_start_at_ctr').hide();
                if (start_when == 'start_immed') {
                    $('#date_start').prop('disabled',true);
                    $('#start_str').html("Starting immediately");
                    return;
                }
                $('#date_start').prop('disabled',false);
                if (start_when == 'start_in') {
                    $('#date_start_in').prop('disabled',false);
                    $('input[name=date_start_unit]').button('enable');
                    $('.date_start_in_ctr').show();
                    change_start_in(0);
                    return;
                }
                if (start_when =='start_at') {
                    $('#date_start_at').timespinner('enable');
                    $('.date_start_at_ctr').show();
                    change_start_at(0);
                    return;
                }
            }
            function change_start_str() {
                var datestart = new Date($('#date_start').val() * 1000);
                var mid_night = new Date(); mid_night.setHours(24,0,0,0); // this is midnight tonight
                var days = ((datestart - mid_night)/(1000*60*60*24));
                var time_part = Globalize.format(datestart, "t");
                var when;
                     if (days<0) when = "at " + time_part;
                else if (days<1) when = "tomorrow at " + time_part;
                else             when = (datestart.toDateString() + ' ' + datestart.toTimeString());
                $('#start_str').html('Start ' + when);
            }
            function change_start_in(e) {
                var date_start_unit = $('input[name=date_start_unit]:checked').val();
                var units = {d:24*60*60, h:60*60, m:60, s:1}[date_start_unit];
                var seconds = $('#date_start_in').val() * units;
                var date_start = Math.ceil(new Date().getTime()/1000 + seconds);
                $('#date_start').val(date_start);
                change_start_str();
            }
            function change_start_at(e) {
                var d = new Date($('#date_start_at').timespinner('value'));
                var proposed = new Date();
                proposed.setHours(d.getHours(), d.getMinutes(), 0, 0);
                var now = new Date();
                if (proposed < now) proposed.setDate(proposed.getDate()+1);
                $('#date_start').val( proposed.getTime()/1000 );
                change_start_str();
            }

            function onclose(ev) {
                console.log("websocket closed with event %o.", ev);
                if ($('#pauseit_form button').prop('started')) {
                    if (g.degrade) g.degrade *= 1.2; else g.degrade = 1;
                    notice("Connection lost.  Re-trying in " + g.degrade.round(1) + ' secs', 'error');
                    $('.ui-button.online').button('disable');
                    window.setTimeout(opensocket, g.degrade*1000);
                    return
                }
                notice("Service Unavailable. Please ensure you are logged-in at binary.com, then retry this page.", 'error');
            }

            function onopen() {
                delete g.degrade;
                console.log("socket opened, authorize with " + g.token);
                g.ws.send(JSON.stringify({authorize:g.token}));
            }

            function onauthorized(data) {
                g.identity = data.loginid + ' ' + (data.fullname||'');
                clear_notice('info');
                clear_notice('error');
                $('#identity').html(g.identity);
                var $but = $('#pauseit_form button');
                $but.prop('started', true);
                localStorage.setItem('token', g.token);
                localStorage.setItem('identity', g.identity);
                $('button#store_token').tooltip('close').hide();
                $('span.ui-button-text', $but).text('Pause');
                $('.ui-button.online').button('enable');
                if (g.contracts_built > 0) {
                    $.each(g.live_contracts, function(contract_id, contract) {
                        contract.destroy();
                    });
                    g.fmb_ids = {};
                    g.live_contracts = {};
                    notice('Connection restored. Previous contract proposals were cancelled');
                    return;
                }
                notice("Getting latest market conditions from Binary.com");
                g.ws.send(JSON.stringify({active_symbols:'display_name'}));
            }

            function opensocket(opts) {
                var handlers = {onclose:onclose,onmessage:onmessage,onopen:onopen};
                g.ws  = new WebSocket('wss://ws.binary.com/websockets/contracts');
                //g.ws  = new WebSocket('ws://www.devbin.io/websockets/contracts');
                $.extend(g.ws, handlers, opts);
            }

            function position(of) {
                return {width: '640px', position:{my:'left top', at: 'left bottom', of:of} /*, modal:true*/}
            }

            function notice(text, level) {
                if (!level) level = 'info';
                var $div = $('#' + level + '-msg');
                $('.notice', $div).text(text);
                $div.show()
            }

            function clear_notice(level) {
                if (!level) level = 'info';
                var $div = $('#' + level + '-msg');
                $('.notice', $div).text('');
                $div.hide();
            }

            function clear_token() {
                delete g.token;
                localStorage.removeItem('token');
                localStorage.removeItem('identity');
                $('#token').val('');
                $('button#clear_token').hide();
                $('button#store_token').show();
                $('#identity').html('');
                var $but = $('#pauseit_form button');
                $but.removeProp('started');
                $but.removeProp('paused');
                $('span.ui-button-text', $but).text('Start');
                $('.ui-button.online').button('disable');
                if (g.ws) {
                    g.ws.onclose = function(){};
                    g.ws.close();
                }
                notice('Token removed');
            }

            function init() { 

                // themeswitcher
                $('#themeswitcher').themeswitcher({pHeight:700, isThemable:true});

                // setup handlers and widgets
                $('#select_symbol')  .click(function(){$('#symbolbuts')  .toggle('medium')}); //dialog(position('#select_symbol'))});
                $('#select_contract').click(function(){$('#contractbuts').toggle('medium')});
                $('#select_duration').click(function(){$('#durationflds').toggle('medium')});
                $('#select_start')   .click(function(){$('#startflds')   .toggle('medium')});
                $('#select_payout')  .click(function(){$('#payoutflds')  .toggle('medium')});
                $('.buttonset').buttonset();
                $('#amount_str').spinner({min:0,numberFormat:"C",change:change_payout});
                $("input[name=currency]").change(change_payout);
                $("input[name=basis]").change(change_payout);
                $("input[name=duration_unit]").change(change_duration);
                $("input[name=ct_bc]").change(change_contract);
                $('#duration').spinner({min:0,change:change_duration});
                $('#duration_date').datepicker({onSelect:change_duration_date});
                $("input#Seconds").prop("checked",true).button('refresh');

                // date_start_in
                $('#date_start_in').spinner({min:0,change:change_start_in});
                $("input#date_start_unit_Seconds").prop("checked",true).button('refresh');
                $("input[name=date_start_unit]").change(change_start_in);

                // date_start_at
                {
                    var start_time = new Date();
                    start_time.setMinutes(start_time.getMinutes()+10);
                    $('#date_start_at').timespinner({change:change_start_at}).timespinner('value', start_time);
                }

                // date_start_when
                $("input[name=start_when]").change(change_startwhen);

                // init to start immed
                $('#startflds  input#start_immed').prop('checked',true).button('refresh').change();

                // contract names
                $('#contractbuts label').each(load_nicetypes);

                //barriers
                $('#slider2').slider({range:true, min:-10, max:+10, values:[-4,4], slide:change_slider2});
                $('#slider1').slider({min:-10, max:+10, value:0, slide:change_slider1});

                // form submit
                $('#pricing_form').submit(pricing_submit);
                $('#portfol_form').submit(portfol_submit);
                $('#pauseit_form').submit(pauseit_submit);
                $('#mytoken_form').submit(mytoken_submit);

                // make all buttons
                $('.button').each(buttonmaker);
                // but disable online ones until online
                $('.ui-button.online').button('disable');

                // nice tooltips
                $('.ttip[title]').tooltip({show:{effect:"slideDown",delay:150}});

                // api token
                $('#clear_token').click(clear_token);
                $('#store_token').click(mytoken_submit);
                g.token = localStorage.getItem('token');
                g.identity = localStorage.getItem('identity');
                if (g.token) {
                    $('#token').val(g.token);
                    $('#identity').html(g.identity);
                    notice('Welcome.');
                    $('button#store_token').hide();
                } else {
                    notice('Welcome.  Please log into Binary.com and retrieve an API Token');
                    $('button#clear_token').hide();
                }

            }
            $(init);

    </script>

</body>
</html>

